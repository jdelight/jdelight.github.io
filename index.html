<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>jamesdacosta.com</title>
    <link rel="stylesheet" href="css/foundation.css"/>
    <link rel="stylesheet" href="css/main.css"/>
    <script src="js/vendor/modernizr.js"></script>
</head>
<body>
<div class="row">
    <div class="small-12 columns">

    <h2 class="subheader logo"><small><a href="/">jamesdacosta.com</a></small></h2>
        <hr/>

    </div>
</div>

<div class="row">
    <div class="large-8 medium-8 columns">
        <div class="post">
            <h3>Setting up a Django app from Mac OSX to Vagrant with Ansible to AWS</h3>
            <h5 class="subheader">1 March 2014</h5>

            <p>Having used some less than desirable VPS solutions in the past I've decided to give some professional solutions a go.</p>
            <p>I've got a simple Django 1.6 Application running on my Mac (using virtualenv) and I'd like to have it running under <a href="http://www.vagrantup.com/">Vagrant</a>.</p>
            <p>Once that's done the next step is to have it running on an AWS EC2 instance - provisioned with Vagrant - and achieve development/production environment consistency...so, here we go!</p>

            <h4>Decoupling from the environment</h4>

            <p>My first consideration is to move settings out of the codebase and into the environment. I've just got one settings.py file at the moment but it makes sense to <a href="http://www.rdegges.com/the-perfect-django-settings-file/">create a settings module</a>.</p>

<pre>
<code>
settings/
├── __init__.py
├── common.py
├── dev.py
└── prod.py
</code>
</pre>

            <p class="caption">The new settings structure</p>

            <p>We'll also need to change the directory <code>BASE_DIR</code> points to.</p>

            <p>Once that's all running again we can think about moving our app to Vagrant.</p>

            <h4>Vagrant</h4>

            <p>Vagrant allows us to setup and manage virtual machines, this means having an enviroment which is predictable and shareable amongst your development team.</p>

            <p>However, even if you're working on a project as a single developer as I am, its still sensible to work in an environment that can be independently managed.</p>

            <p>So to get our Django application into Vagrant the first steps are simple. I've already downloaded and installed Vagrant so from the project root I'll need to setup a Vagrantfile.</p>

            <p>This is as easy as running the <code>vagrant init</code> command with a box specified. In this case I'm using Ubuntu 12.04 as a base.</p>


<pre>
<code>
$ workon [project]
$ vagrant init precise32 http://files.vagrantup.com/precise32.box
$ vagrant up
</code>
</pre>
<p class="caption"><code>workon</code> is a <a href="http://virtualenvwrapper.readthedocs.org/en/latest/">virtualenvwrapper</a> command for getting to project root and activating.</p>

            <p>That should setup the VM, but before we go any further we'll need to edit the Vagrantfile and assign an IP address to it.</p>

            <p>Update the Vagrantfile and uncomment the following:</p>

<pre>
<code class="prettyprint">
config.vm.network :private_network, IP: "192.168.33.10"
</code>
</pre>
            <p>That's pretty much it for Vagrant (for now at least). Next I'll need to install <a href="http://www.ansible.com/">Ansible</a> and get it setting up the Ubuntu VM.</p>

            <h4>Ansible</h4>

            <p>Once we have our VM setup we'll need to install various Ubuntu libraries for python, postgres, Nginx, uwsgi and so on...then get our app deployed. Ansible is capable of all these tasks (and much more). It's also relatively simple to use.</p>

            <p>First, we can install it globally onto the control machine with pip:</p>


<pre>
<code>
$ sudo pip install ansible
</code>
</pre>

            <!--<p>Once that's done check we can ssh to our VM:</p>-->

<!--<pre>-->
<!--<code>-->
<!--$ ssh vagrant@192.168.33.10-->
<!--</code>-->
<!--</pre>-->

            <p>Next we need to setup the <a href="http://docs.ansible.com/intro_inventory.html">inventory file</a> which ansible uses to know about the machines it will manage.</p>

            <p>I'll create a local inventory file for our project:</p>

<pre>
<code>
$ mkdir -p private/ansible/
$ touch private/ansible/hosts
</code>
</pre>

            <p>Next add the IP address of our vagrant machine as a host, so <code>private/ansible/hosts</code> should now contain:</p>

<pre>
<code>
[vagrant]
192.168.33.10
</code>
</pre>


            <p>We should be able to ping our vagrant box now (according to the ansible getting started guide). However, because we only have access to the VM via the vagrant user we'll need to use <code>-u vagrant</code> and also specify the private ssh key.</p>



<pre>
<code class="prettyprint">
$ ansible all \
-m ping \
-i private/ansible/hosts \
-u vagrant \
--private-key ~/.vagrant.d/insecure_private_key
</code>
</pre>
            <p class="caption">You can find out where the private key file is by running <code>vagrant ssh-config</code>.</p>

            <p>That seems a bit unwieldy, so a bash alias without the hosts and modules arguments should fix that.</p>
<pre>
<code class="prettyprint">
    alias ans="ansible \
    -i private/ansible/hosts \
    -u vagrant \
    --private-key ~/.vagrant.d/insecure_private_key"
</code>
</pre>

            <p>And our ad-hoc command becomes: <code>$ ans all -m ping</code> much better!</p>


            <p>So now we can run ad-hoc commands using ansible on the control machine to our Vagrant Ubuntu VM. The next step is to create a simple <a href="http://docs.ansible.com/playbooks_intro.html">playbook</a> and begin some automation.</p>



            <p>First, update the Vagrantfile and include the following which tells vagrant we want to use ansible to provision the VM and includes the path to the inventory file.</p>

<pre>
<code class="prettyprint">
config.vm.provision :ansible do |ansible|
    ansible.playbook = "private/ansible/site.yml"
    ansible.inventory_path = "private/ansible/hosts"
end
</code>
</pre>

            <h4>First Playbook</h4>

            <p>Lets update the main playbook file <code>private/ansible/site.yml</code> and add the following:</p>

<pre>
<code class='prettyprint'>
---
- hosts: vagrant
  tasks:
    - name: test connection
      ping:
</code>
</pre>

            <p>Running <code>$ vagrant provision</code> should produce the output below:</p>

<pre>
<code class='prettyprint'>
[default] Running provisioner: ansible...

PLAY [vagrant] ****************************************************************

GATHERING FACTS ***************************************************************
ok: [192.168.33.10]

TASK: [test connection] *******************************************************
ok: [192.168.33.10]

PLAY RECAP ********************************************************************
192.168.33.10              : ok=2    changed=0    unreachable=0    failed=0
</code>
</pre>



            <p>I'm going to use this repo as a guide for setting up the VM: <a href="https://github.com/airtonix/ansible-django">https://github.com/airtonix/ansible-django</a>.</p>

            <p>The main difference being I'll just use one server for web and database.</p>

            <h4>Nginx</h4>

            <p>Some useful resources for setting up an Ubuntu server with Nginx</p>

            <p>Lets get Nginx installed, I'm going to use roles to distinguish the various aspects of server setup.</p>

            <p>Inside <code>private/ansible/</code> I'll create a roles directory, and add two roles - core and Nginx.</p>

            <p>Core will be responsible to for installing the Nginx prerequisites, and the Nginx role will just install/configure Nginx.</p>



<pre>
<code class='prettyprint'>
private/
    └── ansible
        ├── group_vars
        │   └── all
        ├── hosts
        ├── roles
        │   ├── core
        │   │   └── tasks
        │   │       └── main.yml
        │   └── Nginx
        │       ├── handlers
        │       │   └── main.yml
        │       ├── tasks
        │       │   └── main.yml
        │       └── templates
        │           └── default.conf
        └── site.yml
</code>
</pre>


            <p>In <code>private/ansible/core/tasks/main.yml</code> we'll put the basics needed for Nginx to be installed.</p>

<pre>
<code class='prettyprint'>
---
- name: setup server
  hosts: vagrant
  sudo: true
  roles:
    - core
    - nginx
</code>
</pre>
            <p class="caption">site.yml</p>


<pre>
<code class='prettyprint'>
- name: update apt
  apt: update_cache=yes

- name: install prerequisites
  apt: pkg={{ item }}
  with_items:
    - build-essential
</code>
</pre>
            <p class="caption">core/tasks/main.yml</p>


<pre>
<code class='prettyprint'>
---
- name: install nginx
  apt: name=nginx state=present

- name: copy nginx configuration
  template: src=default.conf dest=/etc/nginx/conf.d/default.conf
  notify: restart nginx
</code>
</pre>
            <p class="caption">nginx/tasks/main.yml</p>


            <hr/>
            <h4>Resources</h4>
            <ul>
                <li><a href="https://www.digitalocean.com/community/articles/initial-server-setup-with-ubuntu-12-04">https://www.digitalocean.com/community/articles/initial-server-setup-with-ubuntu-12-04</a></li>
                <li><a href="https://github.com/owainlewis/vagrant-ansible-django">https://github.com/owainlewis/vagrant-ansible-django</a></li>
                <li><a href="http://davidwinter.me/articles/2013/11/23/introduction-to-ansible/">http://davidwinter.me/articles/2013/11/23/introduction-to-ansible/</a></li>
            </ul>


        </div>

        <div class="post">
            <h3>Hybrid Web Applications</h3>
            <h5 class="subheader">28 February 2014</h5>

            <p>Slides and code from my talk at <a href="http://www.asyncjs.com/">Async</a> (Brighton JavaScript meetup).</p>
            <ul>
                <li>Slides: <a href="http://www.slideshare.net/jamesdac/hybrid-web-applications">http://www.slideshare.net/jamesdac/hybrid-web-applications</a></li>
                <li>Code: <a href="https://github.com/jdelight/imagebase">https://github.com/jdelight/imagebase</a></li>
                <li>Talk overview: <a href="http://lanyrd.com/2014/asyncjs-pjax/">http://lanyrd.com/2014/asyncjs-pjax/</a></li>
            </ul>

        </div>

        <div class="post">
            <h3>Where it began</h3>
            <h5 class="subheader">4 December 2013</h5>

            <p>Like a lot of young people in the early 90's, I was bitten by the programming bug. In my case the Apple II was the machine which provided that sense of adventure.</p>

            <p>20 years later, I'm working in web software development and still amazed by what's possible.</p>

            <p>This blog is a place for me to share my ideas, adventures and learn a few things too...enjoy.</p>

        </div>

    </div>

    <div class="large-4 medium-4 columns aside">
        <div class="row">
            <div class="columns medium-3">
                <a class="th [radius]" href="http://www.twitter.com/jamesdacosta">
                    <img src="img/me.jpg" alt="" width="60"/>
                </a>
            </div>
            <div class="columns medium-9">
                <p class="h1-f">Hello, I'm James, a web developer at <a href="http://www.bright-interactive.com/">Bright Interactive</a>, working with Python & JavaScript.</p>
            </div>
        </div>

        <ul class="no-bullet">
            <li>Twitter: <a href="http://www.twitter.com/jamesdacosta">@jamesdacosta</a></li>
            <li>GitHub: <a href="https://github.com/jdelight/">https://github.com/jdelight/</a></li>
        </ul>
    </div>
</div>

<script src="js/vendor/jquery.js"></script>
<script src="js/foundation.min.js"></script>
<script>
    $(document).foundation();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-3174573-1', 'jamesdacosta.com');
    ga('send', 'pageview');

</script>
</body>
</html>
